<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    {%load static%}
      <link rel="shortcut icon" type="image/png" href="{%static 'images/chat.png' %}">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">

    <title>{%block title%} 
    {%if title is None%}
        Chat in django
        {%endif%}
    {%endblock title%}</title>
  </head>
  <body>
 
  

    {%block body%}
        
    {%endblock body%}
    <script type="text/javascript">

    function validateForm() {
  const name = document.getElementById("name").value;
  if (name.length == 0) {
    alert("name is required");
    return false;
  } else if (name.length >= 15) {
    alert("name length must be between 15 and ");
  } else if (name.trim().length == 0) {
    alert("Please enter a valid name");
    return false;
  } else {
    // document.cookie = "name=" + name;
    return true;
  }
}

console.log("called");
window.load = function () {
  let url = new URL(window.location);
  console.log(url);
};
connectToSocket();

async function sendMessage() {
  let message = document.getElementById("message").value;
  if (message.length == 0) {
    return false;
  } else if (message.trim().length == 0) {
    return false;
  } else {
    let url = new URL(window.location);
    let urlSearchParam = new URLSearchParams(url.search);
    let group = urlSearchParam.get("group");
    let to = urlSearchParam.get("user");
    let data = {
      message: message,
      group: group,
      to: to,
    };
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        const res = JSON.parse(this.response);
        console.log(res);
        message = "  ";
      }
    };
    xhttp.open("POST", "http://localhost:9000/message/send", true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.send(JSON.stringify(data));
    message = "";
  }
}
function connectToSocket() {
  console.log("called");
  let socket = new WebSocket("ws://localhost:9000/ws/wc?group=demo");
  socket.onopen = function (s, event) {
    console.log(s, event);
  };
  socket.onclose = function (s, event) {
    console.log(event);
  };
  socket.onerror = function (s, event) {
    console.log("error", event);
  };
  socket.onmessage = function (s, event) {
    console.log("s", s);
    console.log("event", event);
    const res = JSON.parse(s.data);
    console.log("res", res);
    console.log(res.message);
    message = "";
    let wrapper = document.getElementById("messages");

    let x = `<div class="card mb-3 mt-5 w-50"><a href="#"> <div class="card-body text-decoration-none text-black-50"><blockquote class=" mb-0 text-decoration-none"> <p class="text-decoration-none">${res.from}</p>  <div class="d-flex justify-content-between">
      <span class="text-decoration-none">${res["message"]}</span>
      <span>${res.created_at}</span>
     </div></blockquote></div></a>    </div>`;
  
    if (res["message"] != null) {
      wrapper.innerHTML += x;
    }
  };
}
{% comment %} function createGroup(){
let name=document.getElementById('group_name').value
let xhttp = new XMLHttpRequest();
xhttp.onreadystatechange=function(){
if(this.readyState==4 && xhttp.status==200){
console.log(xhttp.response)
}
}
xhttp.open('POST','http://localhost:9000/group/add',true)
xhttp.setRequestHeader('Content-Type':'application/json')
xhttp.send(JSON.stringify({'group_name':name}))

} {% endcomment %}

</script>

{% comment %} {%load static%}
<script type="text/javascript"src="{%static 'script.js' %}"></script> {% endcomment %}
    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
    -->
  </body>
</html>